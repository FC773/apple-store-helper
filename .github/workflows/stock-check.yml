name: iPhone 17 Pro è£œè²¨ç›£æ§ (é˜²éŒ¯ç‰ˆ)

on:
  schedule:
    - cron: '*/5 * * * *'  # æ¯ 10 åˆ†é˜åŸ·è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  check_stock:
    runs-on: ubuntu-latest

    steps:
      - name: å®‰è£å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: æª¢æŸ¥ Apple å®˜ç¶²åº«å­˜
        run: |
          set -e
          set -o pipefail

          REGION="tw"
          MODEL="iphone17pro"
          COLOR="orange"
          CAPACITY="256gb"
          STORES=("R401" "R425")  # å°åŒ— 101 èˆ‡ä¿¡ç¾© A13
          BARK_URL="https://api.day.app/31d531f61ded93fd8884969a60bf595ee94631c3475ffeadd534bc2864993f79/"

          for STORE in "${STORES[@]}"; do
            RESPONSE=$(curl -s "https://www.apple.com/tw/shop/retail/${STORE}/availability.json?product=${MODEL}&color=${COLOR}&capacity=${CAPACITY}" || echo "")
            
            if [[ -z "$RESPONSE" ]]; then
              echo "âš ï¸ ${STORE} æ²’æœ‰å›æ‡‰ï¼Œè·³é..."
              continue
            fi

            # jq è§£æå¤±æ•—ä¸æœƒçµ‚æ­¢ workflow
            STOCK=$(echo "$RESPONSE" | jq -r '.availability // empty' || echo "")
            
            if [[ "$STOCK" == "true" ]]; then
              MESSAGE="ğŸ‰ ${STORE} æœ‰è²¨ï¼"
              echo "$MESSAGE"
              curl -s "${BARK_URL}${MESSAGE}" || echo "âš ï¸ Bark æ¨æ’­å¤±æ•—"
            else
              echo "${STORE} ç„¡åº«å­˜"
            fi
          done
